<!doctype html>
<html>

<head>
  <title>APIs</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body>
  <!-- NAVBAR COMPONENT -->
  <div id="navbar"></div>
  <div class="navbar-spacer"></div>
  <script>
    fetch('/components/navbar.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('navbar').innerHTML = data;
      });
  </script>
  <!-- NAVBAR COMPONENT -->
  <div id="app"></div>

  <script src="https://cdn.jsdelivr.net/npm/@scalar/api-reference"></script>

  <script>
    const apiUrls = [
      { url: 'https://todo-api.leanderziehm.com/docs/json', title: 'Todo API' },
      { url: 'https://tracker-api.leanderziehm.com/openapi.json', title: 'Tracker API' },
      { url: 'https://llm.leanderziehm.com/openapi.json', title: 'LLM API' },
      { url: 'https://images.leanderziehm.com/openapi.json', title: 'S3 Image API' },
      { url: 'https://notify.leanderziehm.com/openapi.json', title: 'Nofify' },
      // { url: 'https://habits-api.leanderziehm.com/openapi.json', title: 'Habits' }
    ];

    async function fetchAndCombineAPIs(urls) {
      const fetchPromises = urls.map(async ({ url, title }) => {
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`Failed to fetch ${url}: ${res.status}`);
          const data = await res.json();
          return { title, url, data };
        } catch (err) {
          console.error(`Error fetching ${url}:`, err);
          return { title, url, data: null };
        }
      });

      const results = await Promise.all(fetchPromises);

      const combined = {
        openapi: "3.1.0",
        info: { title: "Leander's APIs", version: "1.0.1" },
        paths: {},
        components: {}
      };

      results.forEach(({ title, url, data }) => {
        if (!data) return;

        if (data.paths) {
          for (const path in data.paths) {
            const pathData = data.paths[path];
            for (const method in pathData) {
              // Add x-source and servers to each operation
              pathData[method]['x-source'] = title;
              pathData[method]['servers'] = [{ url }];
            }
            combined.paths[path] = pathData;
          }
        }

        if (data.components) {
          combined.components = { ...combined.components, ...data.components };
        }
      });

      return combined;
    }

    fetchAndCombineAPIs(apiUrls).then((combinedOpenAPI) => {
      Scalar.createApiReference('#app', {
        servers: [
          {
            url: 'https://tracker-api.leanderziehm.com/',
            description: 'Production',
          }],
        showDeveloperTools: 'never',
        hideClientButton: true,
        content: JSON.stringify(combinedOpenAPI, null, 2)
      });
    });
  </script>
</body>

</html>